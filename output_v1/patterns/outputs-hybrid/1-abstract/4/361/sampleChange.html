<link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3>bf7c1895bfb44012dd6d732167fae504c997fd67,anhalytics-commons/src/main/java/fr/inria/anhalytics/commons/dao/anhalytics/OrganisationDAO.java,OrganisationDAO,update,#Organisation#,171
</h3><h3>Before Change</h3><pre><code class='java'>
        PreparedStatement statement1 = connect.prepareStatement(SQL_INSERT_NAMES);
        statement1.setFetchSize(Integer.MIN_VALUE);
        PreparedStatement statement2;
        PreparedStatement <a id="change">statement3</a> = connect.<a id="change">prepareStatement(</a>SQL_UPDATE_END_DATE<a id="change">)</a>;
        statement3.setFetchSize(Integer.MIN_VALUE);

        preparedStatement.setString(1, obj.getType());
        preparedStatement.setString(2, obj.getUrl());
        preparedStatement.setString(3, obj.getStatus());
        preparedStatement.setLong(4, obj.getOrganisationId());
        int code1 = preparedStatement.executeUpdate();

        List&lt;Organisation_Name&gt; names = getOrganisationNames(obj.getOrganisationId());

        for (Organisation_Name name : obj.getNames()) {
            if (names.contains(name)) {
                Organisation_Name existingName = names.get(names.indexOf(name));
                if (name.getLastupdate_date().after(existingName.getLastupdate_date())) {
                    // we keep the most recent publication date to keep track of changing names !
                    try {
                        if (name.getLastupdate_date() == null) {
                            preparedStatement1.setDate(1, new java.sql.Date(00000000L));
                        } else {
                            preparedStatement1.setDate(1, new java.sql.Date(name.getLastupdate_date().getTime()));
                        }
                        preparedStatement1.setLong(2, existingName.getOrganisation_nameid());
                        int code2 = preparedStatement1.executeUpdate();
                    } catch (MySQLIntegrityConstraintViolationException e) {
                        //e.printStackTrace();
                    }
                }
                //update pub date
            } else {
                try {
                    statement1.setLong(1, obj.getOrganisationId());
                    statement1.setString(2, name.getName());
                    if (name.getLastupdate_date() == null) {
                        statement1.setDate(3, new java.sql.Date(00000000L));
                    } else {
                        statement1.setDate(3, new java.sql.Date(name.getLastupdate_date().getTime()));
                    }
                    int code2 = statement1.executeUpdate();
                } catch (MySQLIntegrityConstraintViolationException e) {
                    //e.printStackTrace();
                }
            }
        }
        preparedStatement1.close();
        preparedStatement.close();
        statement1.close();
        //}
        //save date /
        if (obj.getRels().size() &gt; 0) {
            for (PART_OF rel : obj.getRels()) {

                try {

                    PART_OF existingpart_of = getPartOfIfAlreadyStored(obj, rel.getOrganisation_mother());
                    if (existingpart_of != null) {

                        statement2 = connect.prepareStatement(UPDATE_PART_OF, Statement.RETURN_GENERATED_KEYS);
                        if (rel.getFromDate().before(existingpart_of.getFromDate())) {
                            existingpart_of.setFromDate(rel.getFromDate());
                        } else if (rel.getUntilDate().after(existingpart_of.getUntilDate())) {
                            existingpart_of.setUntilDate(rel.getUntilDate());
                        }
                        statement2.setDate(1, new java.sql.Date(existingpart_of.getFromDate().getTime()));

                        statement2.setDate(2, new java.sql.Date(existingpart_of.getUntilDate().getTime()));
                        statement2.setLong(3, obj.getOrganisationId());
                        statement2.setLong(4, rel.getOrganisation_mother().getOrganisationId());
                        int code = statement2.executeUpdate();
                        result = true;
                        statement2.close();
                    } else {

                        PART_OF existingInversepart_of = getPartOfIfAlreadyStored(rel.getOrganisation_mother(), obj);
                        if (existingInversepart_of == null) {
                            statement2 = connect.prepareStatement(SQL_INSERT_MOTHERS);

                            statement2.setFetchSize(Integer.MIN_VALUE);
                            statement2.setLong(1, rel.getOrganisation_mother().getOrganisationId());
                            statement2.setLong(2, obj.getOrganisationId());
                            if (rel.getFromDate() == null) {
                                statement2.setDate(3, new java.sql.Date(00000000L));
                            } else {
                                statement2.setDate(3, new java.sql.Date(rel.getFromDate().getTime()));
                            }
                            if (rel.getUntilDate() == null) {
                                statement2.setDate(4, new java.sql.Date(00000000L));
                            } else {
                                statement2.setDate(4, new java.sql.Date(rel.getUntilDate().getTime()));
                            }

                            int code2 = statement2.executeUpdate();
                            statement2.close();
                        }
                    }
                } catch (MySQLIntegrityConstraintViolationException e) {
                    //e.printStackTrace();
                }
            }
            //update end_date if no relation is found yet
            result = true;

            <a id="change">statement3</a>.<a id="change">close()</a>;
        }
        statement3 = connect.prepareStatement(SQL_INSERT_IDENTIFIERS);
        for (Organisation_Identifier oi : obj.getOrganisation_identifiers()) {</code></pre><h3>After Change</h3><pre><code class='java'>
            statement1 = connect.prepareStatement(SQL_INSERT_NAMES);
            statement1.setFetchSize(Integer.MIN_VALUE);

            statement3 = connect.<a id="change">prepareStatement(</a>SQL_UPDATE_END_DATE<a id="change">)</a>;
            statement3.setFetchSize(Integer.MIN_VALUE);

            preparedStatement.setString(1, obj.getType());</code></pre>